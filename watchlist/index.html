<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchlist</title>
    <meta name="description" content="Displays a list of movies that are to be watched. Includes a list of movies previously watched (completed)">
    <meta name="author" content="Ntshembo Shilowa">
    <link rel="stylesheet" href="/styles/watchlist.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech&display=swap" rel="stylesheet">
</head>

<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="logo-container">
                <h1 class="logo">PIXLBOX</h1>
            </div>
            <div class="menu-container">
                <ul class="menu-list">
                    <button onclick="goToHome()" class="menu-list-item">HOME</button>
                    <button onclick="goToFilms()" class="menu-list-item">FILMS</button>
                    <button onclick="goToGenre()" class="menu-list-item">GENRE</button>
                    <button onclick="goToWatchlist()" class="menu-list-item">WATCHLIST</button>
                    <button onclick="goToFavourites()" class="menu-list-item">FAVOURITES</button>
                </ul>
            </div>
            <div>
                <input type="text" id="searchInput" placeholder="  SEARCH..." onkeyup="searchMovies(event)">
            </div>
        </div>
    </div>

    <div class="filter-container">
        <button onclick="loadWatchlist()" class="filter-btn active">WATCHLIST</button>
        <button onclick="loadHistory()" class="filter-btn">HISTORY</button>
        <button onclick="fetchRecommendedMovies()" class="filter-btn">RECOMMENDED</button>
        <button onclick="fetchTrendingMovies()" class="filter-btn">TRENDING</button>
    </div>

    <main>
        <div class="film-grid" id="filmGrid">
            <div class="loading">Loading your watchlist...</div>
        </div>
    </main>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBoLRWq0eMadmOlOfCyuSVKCYSNvw3Bpmw",
            authDomain: "pixlbox-bfc2d.firebaseapp.com",
            projectId: "pixlbox-bfc2d",
            storageBucket: "pixlbox-bfc2d.firebasestorage.app",
            messagingSenderId: "443728262091",
            appId: "1:443728262091:web:e03df2f6e2a187bccb7c4e",
            measurementId: "G-XTJCVQ3ZG6"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // TMDB API Configuration
        const API_KEY = 'bee2e199532755eba2c0424e6c805c5f';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_BASE_URL = 'https://image.tmdb.org/t/p/w500';

        // DOM Elements
        const filmGrid = document.getElementById('filmGrid');
        const searchInput = document.getElementById('searchInput');

        // Current user state
        let currentUser = null;
        let currentSection = 'watchlist';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadWatchlist();
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = '../login/index.html';
                }
            });
        });

        // Load user's watchlist
        async function loadWatchlist() {
            if (!currentUser) return;
            
            try {
                showLoadingState();
                setActiveFilter('WATCHLIST');
                currentSection = 'watchlist';

                const watchlistDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('watchlist').get();
                
                if (watchlistDoc.empty) {
                    filmGrid.innerHTML = '<div class="no-results">Your watchlist is empty. Add some movies from the Films page!</div>';
                    return;
                }

                const movieIds = watchlistDoc.docs.map(doc => doc.id);
                await displayMoviesByIds(movieIds);
            } catch (error) {
                console.error('Error loading watchlist:', error);
                showErrorState('Failed to load watchlist');
            }
        }

        // Load user's watch history
        async function loadHistory() {
            if (!currentUser) return;
            
            try {
                showLoadingState();
                setActiveFilter('HISTORY');
                currentSection = 'history';

                const historyDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('history').get();
                
                if (historyDoc.empty) {
                    filmGrid.innerHTML = '<div class="no-results">No watch history found. Start watching some movies!</div>';
                    return;
                }

                const movieIds = historyDoc.docs.map(doc => doc.id);
                await displayMoviesByIds(movieIds);
            } catch (error) {
                console.error('Error loading history:', error);
                showErrorState('Failed to load history');
            }
        }

        // Fetch recommended movies based on user's watchlist
        async function fetchRecommendedMovies() {
            try {
                showLoadingState();
                setActiveFilter('RECOMMENDED');
                currentSection = 'recommended';

                // For now, show popular movies as recommendations
                // In a real app, you'd implement more sophisticated recommendation logic
                const response = await fetch(`${BASE_URL}/movie/popular?api_key=${API_KEY}`);
                if (!response.ok) throw new Error('Failed to fetch recommended movies');
                const data = await response.json();
                displayMovies(data.results.slice(0, 12)); // Show first 12 movies
            } catch (error) {
                console.error('Error fetching recommended movies:', error);
                showErrorState('Failed to load recommended movies');
            }
        }

        // Fetch trending movies
        async function fetchTrendingMovies() {
            try {
                showLoadingState();
                setActiveFilter('TRENDING');
                currentSection = 'trending';

                const response = await fetch(`${BASE_URL}/trending/movie/week?api_key=${API_KEY}`);
                if (!response.ok) throw new Error('Failed to fetch trending movies');
                const data = await response.json();
                displayMovies(data.results);
            } catch (error) {
                console.error('Error fetching trending movies:', error);
                showErrorState('Failed to load trending movies');
            }
        }

        // Display movies by their TMDB IDs
        async function displayMoviesByIds(movieIds) {
            const movies = [];
            
            // Fetch movie details for each ID
            for (const movieId of movieIds.slice(0, 20)) { // Limit to 20 movies
                try {
                    const response = await fetch(`${BASE_URL}/movie/${movieId}?api_key=${API_KEY}`);
                    if (response.ok) {
                        const movie = await response.json();
                        movies.push(movie);
                    }
                } catch (error) {
                    console.error(`Error fetching movie ${movieId}:`, error);
                }
            }
            
            displayMovies(movies);
        }

        // Display movies in the grid
        function displayMovies(movies) {
            if (!filmGrid) return;
            filmGrid.innerHTML = '';
            
            if (!movies || movies.length === 0) {
                filmGrid.innerHTML = '<p class="no-results">No movies found</p>';
                return;
            }

            movies.forEach((movie) => {
                const movieElement = createMovieElement(movie);
                filmGrid.appendChild(movieElement);
            });
        }

        // Create movie element
        function createMovieElement(movie) {
            const movieDiv = document.createElement('div');
            movieDiv.className = 'movie-item';
            
            const posterPath = movie.poster_path
                ? `${IMG_BASE_URL}${movie.poster_path}`
                : '../img/placeholder-movie.jpg';

            movieDiv.innerHTML = `
                <img src="${posterPath}" alt="${movie.title}" class="movie-poster">
                <div class="movie-info">
                    <h3 class="movie-title">${movie.title}</h3>
                    <p class="movie-year">${movie.release_date ? movie.release_date.substring(0, 4) : 'TBA'}</p>
                    <div class="movie-rating">‚≠ê ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}</div>
                    <div class="movie-actions">
                        ${currentSection === 'watchlist' ? 
                            `<button class="action-btn watched-btn" onclick="markAsWatched(${movie.id}, '${movie.title}')">Mark as Watched</button>
                             <button class="action-btn remove-btn" onclick="removeFromWatchlist(${movie.id}, '${movie.title}')">Remove</button>` :
                         currentSection === 'history' ?
                            `<button class="action-btn rewatch-btn" onclick="addToWatchlist(${movie.id}, '${movie.title}')">Watch Again</button>
                             <button class="action-btn remove-btn" onclick="removeFromHistory(${movie.id}, '${movie.title}')">Remove</button>` :
                            `<button class="action-btn add-btn" onclick="addToWatchlist(${movie.id}, '${movie.title}')">Add to Watchlist</button>`
                        }
                    </div>
                </div>
            `;

            return movieDiv;
        }

        // Add movie to watchlist
        async function addToWatchlist(movieId, movieTitle) {
            if (!currentUser) return;

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('watchlist').doc(movieId.toString()).set({
                        movieId: movieId,
                        title: movieTitle,
                        addedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                alert(`"${movieTitle}" added to your watchlist!`);
                
                // Reload current section
                if (currentSection === 'watchlist') {
                    loadWatchlist();
                }
            } catch (error) {
                console.error('Error adding to watchlist:', error);
                alert('Failed to add movie to watchlist');
            }
        }

        // Remove movie from watchlist
        async function removeFromWatchlist(movieId, movieTitle) {
            if (!currentUser) return;

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('watchlist').doc(movieId.toString()).delete();
                
                alert(`"${movieTitle}" removed from your watchlist!`);
                loadWatchlist();
            } catch (error) {
                console.error('Error removing from watchlist:', error);
                alert('Failed to remove movie from watchlist');
            }
        }

        // Mark movie as watched
        async function markAsWatched(movieId, movieTitle) {
            if (!currentUser) return;

            try {
                // Add to history
                await db.collection('users').doc(currentUser.uid)
                    .collection('history').doc(movieId.toString()).set({
                        movieId: movieId,
                        title: movieTitle,
                        watchedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                // Remove from watchlist
                await db.collection('users').doc(currentUser.uid)
                    .collection('watchlist').doc(movieId.toString()).delete();
                
                alert(`"${movieTitle}" marked as watched!`);
                loadWatchlist();
            } catch (error) {
                console.error('Error marking as watched:', error);
                alert('Failed to mark movie as watched');
            }
        }

        // Remove movie from history
        async function removeFromHistory(movieId, movieTitle) {
            if (!currentUser) return;

            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('history').doc(movieId.toString()).delete();
                
                alert(`"${movieTitle}" removed from your history!`);
                loadHistory();
            } catch (error) {
                console.error('Error removing from history:', error);
                alert('Failed to remove movie from history');
            }
        }

        // Search functionality
        async function searchMovies(event) {
            if (event.key === 'Enter') {
                const query = searchInput.value.trim();
                if (query === '') {
                    loadWatchlist();
                    return;
                }
                try {
                    showLoadingState();
                    const response = await fetch(
                        `${BASE_URL}/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(query)}`
                    );
                    if (!response.ok) throw new Error('Failed to search movies');
                    const data = await response.json();
                    displayMovies(data.results);
                    setActiveFilter(null);
                } catch (error) {
                    console.error('Error searching movies:', error);
                    showErrorState('Failed to search movies');
                }
            }
        }

        // Utility functions
        function setActiveFilter(activeFilter) {
            document.querySelectorAll('.filter-btn').forEach((btn) => {
                btn.classList.remove('active');
            });
            if (activeFilter) {
                document.querySelectorAll('.filter-btn').forEach((btn) => {
                    if (btn.textContent === activeFilter) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function showLoadingState() {
            if (filmGrid) {
                filmGrid.innerHTML = '<div class="loading">Loading movies...</div>';
            }
        }

        function showErrorState(message) {
            if (filmGrid) {
                filmGrid.innerHTML = `<div class="error">${message}. Please try again later.</div>`;
            }
        }

        // Navigation functions
        function goToHome() {
            window.location.href = '/home/index.html'; 
        }

        function goToFilms() {
            window.location.href = '/films/index.html'; 
        }

        function goToGenre() {
            window.location.href = '/genres/index.html'; 
        }

        function goToWatchlist() {
            window.location.href = '/watchlist/index.html'; 
        }

        function goToFavourites() {
            window.location.href = '/favourites/index.html'; 
        }
    </script>
</body>
</html>